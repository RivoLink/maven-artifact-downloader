/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn more about Gradle by exploring our samples at https://docs.gradle.org/7.3.3/samples
 */

plugins {
    id 'java'
}

repositories {
    google()
    jcenter()
    mavenCentral()

    maven { 
        url "https://jitpack.io" 
    }
}

dependencies {
    implementation "com.github.markusressel:KodeEditor:v4.0.1"
}

task backupCache {
    def homeDir = gradle.gradleUserHomeDir;

    def srcFile = new File(homeDir, 'caches/modules-2/files-2.1')
    def tmpFile = new File(homeDir, 'caches/modules-2/files-2.1-tmp')

    srcFile.renameTo(tmpFile)
}

task restoreCache(type: Delete) {
    def homeDir = gradle.gradleUserHomeDir;

    def srcFile = new File(homeDir, 'caches/modules-2/files-2.1')
    def tmpFile = new File(homeDir, 'caches/modules-2/files-2.1-tmp')

    delete srcFile.absolutePath

    doLast {
        tmpFile.renameTo(srcFile)
    }
}

task copyDependencies(type: Copy) {
    from configurations.default
    into "libs"

    // Backup gradle cache
    dependsOn tasks.backupCache
}

task cacheToMavenLocal(type: Sync) {
    def homeDir = gradle.gradleUserHomeDir;
    def srcFile = new File(homeDir, 'caches/modules-2/files-2.1')

    from srcFile
    into "maven"
    
    // Last copy target wins
    duplicatesStrategy = 'include'
    
    eachFile {
        List<String> parts = it.path.split('/')
        
        // Construct a maven repo file tree from the path 
        it.path = parts[0].replace('.','/') + 
            '/' + parts[1] + 
            '/' + parts[2] + 
            '/' + parts[4]
    }
    
    includeEmptyDirs false

    // Restore gradle cache
    finalizedBy tasks.restoreCache
}